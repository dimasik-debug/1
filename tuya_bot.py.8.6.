#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Tuya Telegram Bot + HTTP Control + WebSocket ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
–í–µ—Ä—Å–∏—è: 2026-02-12 v8.6-websocket-usb-flask_sock-Gismeteo
–ò–∑–º–µ–Ω–µ–Ω–∏—è:
- –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω Telegram-–±–æ—Ç –Ω–∞ polling (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ handlers)
- Flask-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Tuya —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
- HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç: /control?device=ID&com=on/off/toggle/fullstatus&project=1/2/3&format=json/text&notify=true/false
- HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç: /wtags ‚Äî –≤—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö Wireless Sensor Tags (JSON/text, —Ñ–∏–ª—å—Ç—Ä—ã alive_only, pretty)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ com=fullstatus ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤ JSON –∏–ª–∏ —Ç–µ–∫—Å—Ç–µ
- –î–æ–±–∞–≤–ª–µ–Ω —Ç—Ä–µ—Ç–∏–π –ø—Ä–æ–µ–∫—Ç kudrovosmart_delphin
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –∏ –æ—à–∏–±–æ–∫ –≤ Telegram –≤–ª–∞–¥–µ–ª—å—Ü—É —Å IP –∫–ª–∏–µ–Ω—Ç–∞
- –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä notify=true/false ‚Äî –≤–∫–ª—é—á–∞—Ç—å/–æ—Ç–∫–ª—é—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ RuntimeError —Å get_event_loop() ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π notify_loop
- –í /debug –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–∞–π–ª–æ–≤: allowed_users.json, devices.json, button_stats.json
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Wireless Sensor Tags –Ω–∞ —á–∏—Å—Ç–æ–º requests –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫
- –õ–æ–≥–∏–Ω –Ω–∞ https://my.wirelesstag.net/ethAccount.asmx/SignIn —Å POST JSON {email, password}
- –£—á—ë—Ç –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, 405, NameError, ModuleNotFoundError
- –ö–æ–º–∞–Ω–¥—ã /wlist, /wtags + –∫–Ω–æ–ø–∫–∞ "üè∑Ô∏è Wireless Tags"
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ó–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, cap (–≤–ª–∞–∂–Ω–æ—Å—Ç–∏) –∏ –±–∞—Ç–∞—Ä–µ–∏ –≤ —Å–ø–∏—Å–∫–µ —Ç–µ–≥–æ–≤ —Å–æ–∫—Ä–∞—â–µ–Ω—ã –¥–æ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –≤–∏–¥–∞ (‚â§5 —Å–∏–º–≤–æ–ª–æ–≤)
- –£–±—Ä–∞–Ω—ã UUID –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–µ–≥–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω—ã —ç–º–æ–¥–∑–∏ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å Tuya (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ + —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω)
- –î–æ–±–∞–≤–ª–µ–Ω —Å–∏–º–≤–æ–ª –±–∞—Ç–∞—Ä–µ–∏ (ü™´ / üîã) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —è–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ alive: true/false –≤ –≤—ã–≤–æ–¥–µ /wlist ("–æ–Ω–ª–∞–π–Ω, —Å–≤—è–∑—å –µ—Å—Ç—å" / "–æ—Ñ—Ñ–ª–∞–π–Ω")
- –ü–æ–ª–µ humidity –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ cap + –¥–æ–±–∞–≤–ª–µ–Ω–æ —ç–º–æ–¥–∑–∏ üíß –ø–µ—Ä–µ–¥ cap (–µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å—Ç—å)
- –ù–û–í–û–ï: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ WebSocket (flask-socketio) –¥–ª—è –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Å–≤—è–∑–∏ —Å Delphi-–∫–ª–∏–µ–Ω—Ç–æ–º
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ WebSocket
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è send_to_delphi –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –∏–∑ –±–æ—Ç–∞ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –≤ Socket
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–≥–æ–¥–∞
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ UBS-1 –∏ USB-2
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
"""
import asyncio
import logging
import json
import os
import time
import threading
from typing import Dict, Optional, List, Set
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    MessageHandler,
    filters,
)
from tuya_connector import TuyaOpenAPI
from flask import Flask, request, jsonify
from flask_socketio import SocketIO, emit, disconnect
from flask_sock import Sock
import requests
import aiohttp
from bs4 import BeautifulSoup

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BOT_VERSION = "2026-02-12 v8.6-websocket- (OpenMetio,GisMeteo) (c) 2026 Diminssoft"
USER_UID = "eu1573452463464hpG3T"
TUYA_PROJECTS = {
    "naziasmart_securerobot": {
        "name": "Nazia_Smart(securerobot) ‚Äî –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç",
        "endpoint": "https://openapi.tuyaeu.com",
        "access_id": "4hnutju947tgcx5v9kj5",
        "access_key": "ad4a6acdfc5a4c39af196ccd0a6b85a7",
    },
    "naziasmart_dimanbratan": {
        "name": "Nazia_Smart(dimanbratan) ‚Äî –≤—Ç–æ—Ä–æ–π –ø—Ä–æ–µ–∫—Ç",
        "endpoint": "https://openapi.tuyaeu.com",
        "access_id": "ffamhqfxpgetcvmd5gqp",
        "access_key": "d42a23d4e23748a596a47cdb06505eed",
    },
    "kudrovosmart_delphin": {
        "name": "Kudrovo_Smart(delphin) ‚Äî —Ç—Ä–µ—Ç–∏–π –ø—Ä–æ–µ–∫—Ç",
        "endpoint": "https://openapi.tuyaeu.com",
        "access_id": "8utyvwcqcjhdpu8smqq7",
        "access_key": "f14e144e17b94557b13931d60fa71fb3",
    },
}
DEFAULT_PROJECT = "naziasmart_securerobot"
TELEGRAM_TOKEN = "8211074682:AAGGFEYIZdtjnZRqfpzFFzSJt9mK0M6F1mg"
OWNER_ID = 1031513783
PRE_ADDED_USERS = {7060095330, 5902906359}
SWITCH_CODES = ["switch_1", "switch_2", "switch", "switch_led"]
TEMP_CODES = ["va_temperature", "va_humidity", "temperature", "humidity"]
DEVICES_FILE = "devices.json"
ALLOWED_USERS_FILE = "allowed_users.json"
BUTTON_STATS_FILE = "button_stats.json"
devices_cache: Dict[str, str] = {}
ALLOWED_USERS: Set[int] = set()
application_global = None
notify_loop = asyncio.new_event_loop()
threading.Thread(target=notify_loop.run_forever, daemon=True).start()
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Wireless Sensor Tags –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
WTAGS_ENABLED = True
WTAGS_EMAIL = "dimanbratan@yandex.ru"
WTAGS_PASSWORD = "887826"
WTAGS_SIGNIN_URL = "https://my.wirelesstag.net/ethAccount.asmx/SignIn"
WTAGS_GET_TAGS_URL = "https://my.wirelesstag.net/ethClient.asmx/GetTagList"
wtags_session = requests.Session()
wtags_logged_in = False

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–∞–∑–≤–∞–Ω–∏—è –¥–ª—è USB (16 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–∞–∑–≤–∞–Ω–∏—è –¥–ª—è USB1 (8 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
USB1_NAMES = [
    "–û–±–æ–≥—Ä–µ–≤–∞—Ç–µ–ª—å",     # 1
    "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä",       # 2
    "–°–≤–µ—Ç –≤ –≥–∞—Ä–∞–∂–µ",    # 3
    "–ù–∞—Å–æ—Å",            # 4
    "–¢—ë–ø–ª—ã–π –ø–æ–ª",       # 5
    "–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä",      # 6
    "–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞",       # 7
    "–ó–∞—Ä—è–¥–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"  # 8
]

# –ù–∞–∑–≤–∞–Ω–∏—è –¥–ª—è USB2 (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥—Ä—É–≥–∏–µ ‚Äî –ø–æ–º–µ–Ω—è–π)
USB2_NAMES = [
    "–õ–∞–º–ø–∞ 1",          # 1
    "–õ–∞–º–ø–∞ 2",          # 2
    "–†–æ–∑–µ—Ç–∫–∞ –∫—É—Ö–Ω—è",    # 3
    "–†–æ–∑–µ—Ç–∫–∞ —Å–ø–∞–ª—å–Ω—è",  # 4
    "–£–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å",      # 5
    "–ü—ã–ª–µ—Å–æ—Å",          # 6
    "–¢–µ–ª–µ–≤–∏–∑–æ—Ä",        # 7
    "–ó–≤—É–∫"              # 8
]

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ü–æ–≥–æ–¥–∞ ‚Äî –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ –∏ YANDEX_WEATHER_KEY GISMETEO_CITIES
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

CITIES_WEATHER = {
    "spb": {"name": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "query": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"},
    "kudrovo": {"name": "–ö—É–¥—Ä–æ–≤–æ", "query": "–ö—É–¥—Ä–æ–≤–æ"},
    "naziya": {"name": "–ù–∞–∑–∏—è", "query": "–ù–∞–∑–∏—è"},
    "putilovo": {"name": "–ü—É—Ç–∏–ª–æ–≤–æ", "query": "–ü—É—Ç–∏–ª–æ–≤–æ"},
}
YANDEX_WEATHER_KEY = "d469788e-0e02-4b9b-9163-164637fb6479"

GISMETEO_CITIES = {
    "spb": {
        "name": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
        "slug": "sankt-peterburg",
        "id": 4079,
        "lat": 59.934,
        "lon": 30.335
    },
    "kudrovo": {
        "name": "–ö—É–¥—Ä–æ–≤–æ",
        "slug": "kudrovo",
        "id": 12454,
        "lat": 59.908,
        "lon": 30.491
    },
}

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 "
                  "(KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",
    "Accept-Language": "ru-RU,ru;q=0.9,en;q=0.8",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Referer": "https://www.gismeteo.ru/",
}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
logging.basicConfig(level=logging.INFO, format='%(asctime)s | %(levelname)s | %(message)s')
logger = logging.getLogger(f"TuyaBot {BOT_VERSION}")
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Flask + SocketIO
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
flask_app = Flask(__name__)
socketio = SocketIO(flask_app, cors_allowed_origins="*", async_mode='threading')
# –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è WebSocket (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–ó–ú–ï–ù–ò –ù–ê –°–í–û–ô!)
WEBSOCKET_SECRET_TOKEN = "eu1573452463464hpG3T"
# –°–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤: sid ‚Üí client_id
connected_clients = {}
@flask_app.route('/')
def home():
    return (
        f"Tuya Bot + HTTP + WebSocket {BOT_VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç\n\n"
        "Telegram-–±–æ—Ç: –∞–∫—Ç–∏–≤–µ–Ω (polling)\n"
        "HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:\n"
        " /control?... (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Tuya)\n"
        " /wtags?... (—Å—Ç–∞—Ç—É—Å Wireless Tags)\n"
        "WebSocket: wss://dimasik-debug-tuya-bot-a9bc.twc1.net/socket.io/?token=...&client_id=...\n"
    )
@flask_app.route('/control', methods=['GET'])
def control():
    device_id = request.args.get('device')
    com = request.args.get('com', '').lower()
    project_str = request.args.get('project', '1')
    format_type = request.args.get('format', 'json').lower()
    notify_str = request.args.get('notify', 'true').lower()
    notify = notify_str != 'false'
    if not device_id:
        return jsonify({"success": False, "error": "device –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}), 400
    if project_str not in ['1', '2', '3']:
        return jsonify({"success": False, "error": "project –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 1, 2 –∏–ª–∏ 3"}), 400
    project_key = "naziasmart_securerobot" if project_str == '1' else \
                  "naziasmart_dimanbratan" if project_str == '2' else \
                  "kudrovosmart_delphin"
    client_ip = request.remote_addr or "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    try:
        tuya = asyncio.run(get_tuya_api(project_key, None))
        if com == 'fullstatus':
            status_resp = tuya.get(f"/v1.0/devices/{device_id}/status")
            if not status_resp.get("success"):
                error_msg = format_tuya_error(status_resp)
                if notify:
                    asyncio.run_coroutine_threadsafe(
                        application_global.bot.send_message(
                            OWNER_ID,
                            f"–û—à–∏–±–∫–∞ HTTP-–∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞:\n"
                            f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {get_device_name(device_id)} ({device_id})\n"
                            f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[project_key]['name']}\n"
                            f"IP –∫–ª–∏–µ–Ω—Ç–∞: {client_ip}\n"
                            f"{error_msg}"
                        ),
                        notify_loop
                    )
                return jsonify({"success": False, "error": error_msg}), 500
            result = {}
            text_lines = [f"–ü–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å {get_device_name(device_id)} ({device_id}):"]
            for item in status_resp.get("result", []):
                code = item.get("code")
                value = item.get("value")
                result[code] = value
                display_value = value
                if code in SWITCH_CODES:
                    display_value = "–í–∫–ª" if value else "–í—ã–∫–ª"
                elif code in TEMP_CODES:
                    if "temperature" in code:
                        display_value = f"{value / 10:.1f}¬∞C"
                    elif "humidity" in code:
                        display_value = f"{value}%"
                text_lines.append(f"{code}: {display_value}")
            if notify:
                asyncio.run_coroutine_threadsafe(
                    application_global.bot.send_message(
                        OWNER_ID,
                        f"HTTP-–∑–∞–ø—Ä–æ—Å –ø–æ–ª–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞\n"
                        f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {get_device_name(device_id)} ({device_id})\n"
                        f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[project_key]['name']}\n"
                        f"IP –∫–ª–∏–µ–Ω—Ç–∞: {client_ip}"
                    ),
                    notify_loop
                )
            if format_type == 'text':
                return "\n".join(text_lines), 200, {'Content-Type': 'text/plain; charset=utf-8'}
            return jsonify({
                "success": True,
                "device": device_id,
                "project": project_key,
                "full_status": result
            })
        if com not in ['on', 'off', 'toggle']:
            return jsonify({"success": False, "error": "com –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å on / off / toggle / fullstatus"}), 400
        status_resp = tuya.get(f"/v1.0/devices/{device_id}/status")
        if not status_resp.get("success"):
            error_msg = format_tuya_error(status_resp)
            if notify:
                asyncio.run_coroutine_threadsafe(
                    application_global.bot.send_message(
                        OWNER_ID,
                        f"–û—à–∏–±–∫–∞ HTTP-–∫–æ–º–∞–Ω–¥—ã {com.upper()}:\n"
                        f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {get_device_name(device_id)} ({device_id})\n"
                        f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[project_key]['name']}\n"
                        f"IP –∫–ª–∏–µ–Ω—Ç–∞: {client_ip}\n"
                        f"{error_msg}"
                    ),
                    notify_loop
                )
            return jsonify({"success": False, "error": error_msg}), 500
        current_value = None
        for item in status_resp.get("result", []):
            if item.get("code") in SWITCH_CODES:
                current_value = item.get("value")
                break
        if current_value is None:
            error_msg = "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ"
            if notify:
                asyncio.run_coroutine_threadsafe(
                    application_global.bot.send_message(
                        OWNER_ID,
                        f"–û—à–∏–±–∫–∞ HTTP-–∫–æ–º–∞–Ω–¥—ã {com.upper()}:\n"
                        f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {get_device_name(device_id)} ({device_id})\n"
                        f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[project_key]['name']}\n"
                        f"IP –∫–ª–∏–µ–Ω—Ç–∞: {client_ip}\n"
                        f"{error_msg}"
                    ),
                    notify_loop
                )
            return jsonify({"success": False, "error": error_msg}), 400
        if com == 'toggle':
            new_value = not current_value
            action_text = "–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ"
        elif com == 'on':
            new_value = True
            action_text = "–≤–∫–ª—é—á–µ–Ω–æ"
        else:
            new_value = False
            action_text = "–≤—ã–∫–ª—é—á–µ–Ω–æ"
        payload = {"commands": [{"code": "switch_1", "value": new_value}]}
        cmd_resp = tuya.post(f"/v1.0/devices/{device_id}/commands", payload)
        if cmd_resp.get("success"):
            if notify:
                device_name = get_device_name(device_id)
                asyncio.run_coroutine_threadsafe(
                    application_global.bot.send_message(
                        OWNER_ID,
                        f"–ö–æ–º–∞–Ω–¥–∞ —á–µ—Ä–µ–∑ HTTP: {action_text.upper()}\n"
                        f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {device_name} ({device_id})\n"
                        f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[project_key]['name']}\n"
                        f"IP –∫–ª–∏–µ–Ω—Ç–∞: {client_ip}"
                    ),
                    notify_loop
                )
            return jsonify({
                "success": True,
                "device": device_id,
                "action": action_text,
                "new_state": new_value,
                "project": project_key
            })
        else:
            error_msg = format_tuya_error(cmd_resp)
            if notify:
                asyncio.run_coroutine_threadsafe(
                    application_global.bot.send_message(
                        OWNER_ID,
                        f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP-–∫–æ–º–∞–Ω–¥—ã {com.upper()}:\n"
                        f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {get_device_name(device_id)} ({device_id})\n"
                        f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[project_key]['name']}\n"
                        f"IP –∫–ª–∏–µ–Ω—Ç–∞: {client_ip}\n"
                        f"{error_msg}"
                    ),
                    notify_loop
                )
            return jsonify({"success": False, "error": error_msg}), 500
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ /control: {str(e)}")
        if notify:
            asyncio.run_coroutine_threadsafe(
                application_global.bot.send_message(
                    OWNER_ID,
                    f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ HTTP-–∫–æ–Ω—Ç—Ä–æ–ª–µ:\n"
                    f"–ö–æ–º–∞–Ω–¥–∞: {com.upper()}\n"
                    f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: {device_id}\n"
                    f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[project_key]['name']}\n"
                    f"IP –∫–ª–∏–µ–Ω—Ç–∞: {client_ip}\n"
                    f"{str(e)}"
                ),
                notify_loop
            )
        return jsonify({"success": False, "error": str(e)}), 500
@flask_app.route('/wtags', methods=['GET'])
def wtags_status():
    format_type = request.args.get('format', 'json').lower()
    pretty = request.args.get('pretty', 'false').lower() == 'true'
    alive_only = request.args.get('alive_only', 'false').lower() == 'true'
    tags = wtags_get_tags()
    if not tags:
        if format_type == 'text':
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Wireless Tags (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –±–æ—Ç–∞)", 503
        else:
            return jsonify({
                "success": False,
                "error": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤",
                "tags": []
            }), 503
    if alive_only:
        tags = [t for t in tags if t.get("alive", False)]
    result = []
    for tag in tags:
        item = {
            "name": tag.get("name", "–ë–µ–∑ –∏–º–µ–Ω–∏"),
            "uuid": tag.get("uuid", "N/A"),
            "alive": tag.get("alive", False),
            "status": "–æ–Ω–ª–∞–π–Ω" if tag.get("alive", False) else "–æ—Ñ—Ñ–ª–∞–π–Ω",
            "temperature": tag.get("temperature"),
            "batteryVolt": tag.get("batteryVolt"),
            "batteryRemaining": tag.get("batteryRemaining"),
            "signaldBm": tag.get("signaldBm"),
            "lastComm": tag.get("lastComm"),
            "OutOfRange": tag.get("OutOfRange", False),
            "lux": tag.get("lux"),
            "cap": tag.get("cap")
        }
        result.append(item)
    if format_type == 'text':
        lines = ["Wireless Sensor Tags ‚Äî —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:"]
        for item in result:
            lines.append(f"‚Ä¢ {item['name']}")
            lines.append(f" –°—Ç–∞—Ç—É—Å: {item['status']}")
            lines.append(f" –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {item['temperature'] if item['temperature'] is not None else 'N/A'} ¬∞C")
            lines.append(f" –ë–∞—Ç–∞—Ä–µ—è: {item['batteryVolt'] if item['batteryVolt'] is not None else 'N/A'} V "
                         f"({item['batteryRemaining']*100:.0f}% –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)")
            lines.append(f" –°–∏–≥–Ω–∞–ª: {item['signaldBm']} dBm")
            lines.append(f" OutOfRange: {'–¥–∞' if item['OutOfRange'] else '–Ω–µ—Ç'}")
            lines.append("---")
        return "\n".join(lines), 200, {'Content-Type': 'text/plain; charset=utf-8'}
    else:
        response = {
            "success": True,
            "count": len(result),
            "alive_count": sum(1 for t in result if t["alive"]),
            "tags": result,
            "timestamp": datetime.utcnow().isoformat() + "Z"
        }
        if pretty:
            return jsonify(response), 200, {'Content-Type': 'application/json; charset=utf-8'}
        else:
            return jsonify(response)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# WebSocket –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–¥–ª—è —Å–≤—è–∑–∏ —Å Delphi –∏ –¥—Ä—É–≥–∏–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# –°–ª–æ–≤–∞—Ä—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
# –ö–ª—é—á ‚Äî –∏–º—è –∫–æ–º–∞–Ω–¥—ã, –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî —Ñ—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç: data (dict), emit (—Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—Ç–∞), sid (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏)
command_handlers = {}


def register_ws_command(name):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã"""
    def decorator(func):
        command_handlers[name] = func
        return func
    return decorator


# ‚îÄ‚îÄ‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@register_ws_command("get_wtags")
def handle_get_wtags(data, emit, sid):
    tags = wtags_get_tags()
    emit('response', {
        'command': 'get_wtags',
        'success': bool(tags),
        'count': len(tags) if tags else 0,
        'data': tags or [],
        'timestamp': datetime.utcnow().isoformat() + "Z"
    })


@register_ws_command("turn_on_device")
def handle_turn_on_device(data, emit, sid):
    device_id = data.get('device_id')
    project_str = data.get('project', '1')

    if not device_id:
        emit('response', {'command': 'turn_on_device', 'success': False, 'error': 'device_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'})
        return

    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è (–∫–∞–∫ –≤ /control)
    # –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫—É ‚Äî –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –∫–æ–¥
    emit('response', {
        'command': 'turn_on_device',
        'success': True,
        'device_id': device_id,
        'project': project_str,
        'action': 'on',
        'new_state': True,
        'message': '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–∫–ª—é—á–µ–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞)'
    })


@register_ws_command("turn_off_device")
def handle_turn_off_device(data, emit, sid):
    device_id = data.get('device_id')
    project_str = data.get('project', '1')

    if not device_id:
        emit('response', {'command': 'turn_off_device', 'success': False, 'error': 'device_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'})
        return

    # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è
    emit('response', {
        'command': 'turn_off_device',
        'success': True,
        'device_id': device_id,
        'project': project_str,
        'action': 'off',
        'new_state': False,
        'message': '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–∫–ª—é—á–µ–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞)'
    })


@register_ws_command("toggle_device")
def handle_toggle_device(data, emit, sid):
    device_id = data.get('device_id')
    project_str = data.get('project', '1')

    if not device_id:
        emit('response', {'command': 'toggle_device', 'success': False, 'error': 'device_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'})
        return

    # –ó–¥–µ—Å—å –Ω—É–∂–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è + –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
    emit('response', {
        'command': 'toggle_device',
        'success': True,
        'device_id': device_id,
        'project': project_str,
        'action': 'toggle',
        'new_state': '–∏–∑–º–µ–Ω–µ–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞)',
        'message': '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ (–∑–∞–≥–ª—É—à–∫–∞)'
    })


@register_ws_command("ping")
def handle_ping(data, emit, sid):
    emit('response', {
        'command': 'ping',
        'success': True,
        'pong': True,
        'timestamp': time.time(),
        'client_id': connected_clients.get(sid, 'unknown')
    })


# ‚îÄ‚îÄ‚îÄ‚îÄ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è / –æ—Ç–∫–ª—é—á–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@socketio.on('connect')
def ws_connect():
    token = request.args.get('token')
    client_id = request.args.get('client_id', 'unknown')

    if token != WEBSOCKET_SECRET_TOKEN:
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º –æ—Ç {client_id} (IP: {request.remote_addr})")
        disconnect()
        return

    connected_clients[request.sid] = client_id
    logger.info(f"–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è: {client_id} (sid: {request.sid}, IP: {request.remote_addr})")
    emit('welcome', {
        'message': f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {client_id}! –í—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ TuyaBot.',
        'version': BOT_VERSION,
        'timestamp': datetime.utcnow().isoformat() + "Z"
    })


@socketio.on('disconnect')
def ws_disconnect():
    client_id = connected_clients.pop(request.sid, 'unknown')
    logger.info(f"–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è: {client_id} (sid: {request.sid})")


# ‚îÄ‚îÄ‚îÄ‚îÄ –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –∫–æ–º–∞–Ω–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@socketio.on('command_to_bot')
def handle_command_from_delphi(data):
    sid = request.sid
    client_id = connected_clients.get(sid, 'unknown')
    cmd = data.get('command')

    if not cmd:
        emit('response', {
            'success': False,
            'error': '–ü–æ–ª–µ "command" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'
        })
        return

    logger.info(f"–ö–æ–º–∞–Ω–¥–∞ –æ—Ç {client_id} (sid={sid}): {cmd} | –¥–∞–Ω–Ω—ã–µ: {data}")

    handler = command_handlers.get(cmd)

    if handler:
        try:
            handler(data, emit, sid)
        except Exception as e:
            logger.exception(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã '{cmd}' –æ—Ç {client_id}")
            emit('response', {
                'command': cmd,
                'success': False,
                'error': str(e) or '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
            })
    else:
        logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ '{cmd}' –æ—Ç {client_id}")
        emit('response', {
            'command': cmd,
            'success': False,
            'error': f'–ö–æ–º–∞–Ω–¥–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: {cmd}'
        })


# ‚îÄ‚îÄ‚îÄ‚îÄ –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def send_to_delphi(client_id: str, message: dict):
    for sid, cid in list(connected_clients.items()):
        if cid == client_id:
            socketio.emit('command_from_bot', message, room=sid)
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É {client_id} (sid={sid}): {message}")
            return True
    logger.warning(f"–ö–ª–∏–µ–Ω—Ç {client_id} –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö")
    return False


# ‚îÄ‚îÄ‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ Flask + SocketIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def run_flask():
    port = int(os.getenv("PORT", 8080))
    logger.info(f"–ó–∞–ø—É—Å–∫ Flask + SocketIO –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    socketio.run(
        flask_app,
        host="0.0.0.0",
        port=port,
        debug=False,
        use_reloader=False,
        allow_unsafe_werkzeug=True
        )
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def file_info(path: str) -> str:
    if not os.path.exists(path):
        return f"–§–∞–π–ª {path} –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    size = os.path.getsize(path)
    mtime = os.path.getmtime(path)
    mtime_str = datetime.fromtimestamp(mtime).strftime('%Y-%m-%d %H:%M:%S')
    try:
        with open(path, 'r', encoding='utf-8') as f:
            content = f.read()
            preview = content[:200] + "..." if len(content) > 200 else content
        return f"–§–∞–π–ª {path}:\n–†–∞–∑–º–µ—Ä: {size} –±–∞–π—Ç\n–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: {mtime_str}\n–°–æ–¥–µ—Ä–∂–∏–º–æ–µ (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤):\n{preview}"
    except Exception as e:
        return f"–§–∞–π–ª {path} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: {str(e)}"
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Wireless Sensor Tags ‚Äî —á–∏—Å—Ç—ã–π requests (–∞—Åmx/SignIn)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def wtags_login() -> bool:
    global wtags_logged_in
    if not WTAGS_ENABLED:
        return False
    try:
        headers = {
            "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Content-Type": "application/json",
            "Origin": "https://my.wirelesstag.net",
            "Referer": "https://my.wirelesstag.net/eth/signin.html",
            "Connection": "keep-alive"
        }
        payload = {
            "email": WTAGS_EMAIL,
            "password": WTAGS_PASSWORD
        }
       
        resp = wtags_session.post(
            WTAGS_SIGNIN_URL,
            json=payload,
            headers=headers,
            timeout=15
        )
        logger.info(f"WTAGS SignIn ‚Üí status: {resp.status_code}")
        logger.info(f"WTAGS SignIn ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω—ã–π URL: {resp.url}")
        logger.info(f"WTAGS SignIn ‚Üí –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(resp.text)}")
        #logger.info(f"WTAGS SignIn ‚Üí –ü–û–õ–ù–´–ô –û–¢–í–ï–¢ –°–ï–†–í–ï–†–ê: {resp.text}")
       
       
        if resp.status_code == 200:
            try:
                data = resp.json()
                logger.info(f"WTAGS SignIn ‚Üí —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π JSON: {data}")
                d = data.get("d")
                if d is None:
                    logger.warning("WTAGS SignIn: –ø–æ–ª–µ 'd' = null –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
                    wtags_logged_in = True
                    return True
                if isinstance(d, dict):
                    success = d.get("success", False)
                    if success:
                        wtags_logged_in = True
                        logger.info("WTAGS: –ª–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω (success: true)")
                        return True
                    else:
                        err_msg = d.get("errorMessage", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
                        logger.error(f"WTAGS SignIn failed: {err_msg}")
                        return False
                else:
                    logger.warning("WTAGS SignIn: 'd' –Ω–µ —Å–ª–æ–≤–∞—Ä—å")
                    return False
            except ValueError as ve:
                logger.error(f"WTAGS SignIn: –æ—Ç–≤–µ—Ç –Ω–µ JSON - {str(ve)}")
                logger.info(f"WTAGS SignIn —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: {resp.text[:1000]}")
                return False
        else:
            logger.error(f"WTAGS SignIn HTTP –æ—à–∏–±–∫–∞: {resp.status_code}")
            return False
    except Exception as e:
        logger.error(f"WTAGS SignIn –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(e)}")
        return False
def wtags_get_tags() -> List[Dict]:
    wtags_login() # –≤—ã–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —É–∂–µ –ª–æ–≥–∏–Ω –±—ã–ª
    try:
        headers = {
            "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Content-Type": "application/json"
        }
        resp = wtags_session.post(
            WTAGS_GET_TAGS_URL,
            json={}, # –ø—É—Å—Ç–æ–π body, –∫–∞–∫ –≤ —Ç–≤–æ—ë–º Network
            headers=headers,
            timeout=15
        )
        logger.info(f"WTAGS GetTagList ‚Üí status: {resp.status_code}")
        logger.info(f"WTAGS GetTagList ‚Üí –ü–û–õ–ù–´–ô –û–¢–í–ï–¢: {resp.text}")
        if resp.status_code == 200:
            data = resp.json()
            tags = data.get("d", [])
            logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Ç–µ–≥–æ–≤: {len(tags)}")
            return tags
        else:
            return []
    except Exception as e:
        logger.error(f"WTAGS GetTagList error: {str(e)}")
        return []
def wtags_get_readings(tag_uuid: str) -> Dict:
    if not wtags_logged_in and not wtags_login():
        return {}
    try:
        headers = {
            "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Content-Type": "application/json"
        }
        payload = {"uuid": tag_uuid}
        resp = wtags_session.post(
            "https://my.wirelesstag.net/ethClient.asmx/GetSensorReadings",
            json=payload,
            headers=headers,
            timeout=15
        )
        logger.info(f"WTAGS GetSensorReadings ‚Üí status: {resp.status_code}")
        logger.info(f"WTAGS GetSensorReadings ‚Üí –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(resp.text)}")
        if resp.status_code == 200:
            try:
                data = resp.json()
                readings = data.get("d", {})
                return readings
            except ValueError:
                logger.error("WTAGS GetSensorReadings: –æ—Ç–≤–µ—Ç –Ω–µ JSON")
                return {}
        else:
            logger.error(f"WTAGS GetSensorReadings HTTP –æ—à–∏–±–∫–∞: {resp.status_code}")
            return {}
    except Exception as e:
        logger.error(f"WTAGS GetSensorReadings –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(e)}")
        return {}
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π Wireless Tags (‚â§5 —Å–∏–º–≤–æ–ª–æ–≤)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def compact_value(val, unit: str = "", decimals: int = 1) -> str:
    """–°–æ–∫—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ –¥–æ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –≤–∏–¥–∞ ‚â§5 —Å–∏–º–≤–æ–ª–æ–≤"""
    if val is None or not isinstance(val, (int, float)):
        return "N/A"
    if decimals == 0:
        s = f"{int(round(val))}{unit}"
    else:
        s = f"{val:.{decimals}f}{unit}"
    return s[:5]
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –§—É–Ω–∫—Ü–∏–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (–≤—Å–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def load_allowed_users() -> Set[int]:
    if os.path.exists(ALLOWED_USERS_FILE):
        try:
            with open(ALLOWED_USERS_FILE, 'r') as f:
                data = json.load(f)
                return set(data.get("users", []))
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ allowed_users: {e}")
            return {OWNER_ID} | PRE_ADDED_USERS
    else:
        initial_users = {OWNER_ID} | PRE_ADDED_USERS
        save_allowed_users(initial_users)
        return initial_users
def save_allowed_users(users_set: Set[int]):
    try:
        with open(ALLOWED_USERS_FILE, 'w') as f:
            json.dump({"users": list(users_set)}, f, indent=2)
        logger.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(users_set)} —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è allowed_users: {e}")
ALLOWED_USERS = load_allowed_users()
def has_access(user_id: int) -> bool:
    return user_id in ALLOWED_USERS
def load_devices() -> List[Dict]:
    if os.path.exists(DEVICES_FILE):
        try:
            with open(DEVICES_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {DEVICES_FILE}: {e}")
    return []
def save_devices(devices: List[Dict]):
    try:
        with open(DEVICES_FILE, 'w', encoding='utf-8') as f:
            json.dump(devices, f, ensure_ascii=False, indent=2)
        logger.info("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
def update_devices_cache(devices: List[Dict]):
    global devices_cache
    devices_cache.clear()
    for dev in devices:
        dev_id = dev.get('id')
        name = dev.get('name', '–ë–µ–∑ –∏–º–µ–Ω–∏')
        if dev_id:
            devices_cache[dev_id] = name
def get_device_name(dev_id: str) -> str:
    name = devices_cache.get(dev_id)
    if name:
        return name
    devices = load_devices()
    for dev in devices:
        if dev.get("id") == dev_id:
            return dev.get("name", "–ë–µ–∑ –∏–º–µ–Ω–∏")
    return "–ë–µ–∑ –∏–º–µ–Ω–∏"
def format_tuya_error(response: Dict) -> str:
    code = response.get("code", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    msg = response.get("msg") or response.get("error") or "–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"
    explanations = {
        1106: "Permission deny ‚Äî –ø—Ä–∏–≤—è–∂–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
        1108: "URI path invalid ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∏–≤—è–∑–∫—É",
        2017: "Token expired",
        1004: "Invalid app key",
        1005: "Invalid app secret",
        60001001: "–ö–≤–æ—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å—á–µ—Ä–ø–∞–Ω–∞ ‚Äî —É–¥–∞–ª–∏ –ª–∏—à–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏ —Ç–∞—Ä–∏—Ñ",
    }
    explanation = explanations.get(code, "")
    if code in [1106, 1108]:
        explanation += "\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: iot.tuya.com ‚Üí Devices ‚Üí Link My App"
    return f"Tuya –æ—à–∏–±–∫–∞ {code}: {msg}\n{explanation}"
async def get_tuya_api(project_key: str, context: Optional[ContextTypes.DEFAULT_TYPE] = None) -> TuyaOpenAPI:
    proj = TUYA_PROJECTS.get(project_key)
    if not proj:
        raise ValueError(f"–ü—Ä–æ–µ–∫—Ç {project_key} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    api = TuyaOpenAPI(proj["endpoint"], proj["access_id"], proj["access_key"])
    try:
        api.connect()
        if context:
            context.bot_data["current_tuya"] = api
            context.bot_data["current_project"] = project_key
        logger.info(f"–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ {proj['name']}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ connect {proj['name']}: {e}")
        raise
    return api
async def get_current_tuya(context: ContextTypes.DEFAULT_TYPE) -> TuyaOpenAPI:
    tuya = context.bot_data.get("current_tuya")
    if not tuya:
        await get_tuya_api(DEFAULT_PROJECT, context)
        tuya = context.bot_data["current_tuya"]
    return tuya
async def get_uid(context: ContextTypes.DEFAULT_TYPE) -> str:
    return USER_UID
def get_reply_keyboard():
    keyboard = [
        [KeyboardButton("üå§Ô∏è –ü–æ–≥–æ–¥–∞"),KeyboardButton("üîå –í—ã–∫–ª—é—á–∞—Ç–µ–ª–∏"), KeyboardButton("üå°Ô∏è –î–∞—Ç—á–∏–∫–∏")],
        [KeyboardButton("üìã –ü—Ä–æ–µ–∫—Ç—ã"), KeyboardButton("üìú –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤")],
        [KeyboardButton("üè∑Ô∏è Wireless Tags"),KeyboardButton("–†–µ–ª–µ 1"), KeyboardButton("–†–µ–ª–µ 2")],
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
async def post_init(application: Application) -> None:
    text = f"üî• Tuya Bot v{BOT_VERSION} –∑–∞–ø—É—â–µ–Ω!\n\n"
    current_key = application.bot_data.get("current_project", DEFAULT_PROJECT)
    name = TUYA_PROJECTS[current_key]["name"]
    text += f"–¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç: {name}\n"
    text += f"UID: {USER_UID}\n"
    text += f"–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(ALLOWED_USERS)}\n"
    text += "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! /list /temp /switch\n"
    text += "HTTP-–∫–æ–Ω—Ç—Ä–æ–ª—å –∞–∫—Ç–∏–≤–µ–Ω: /control?device=ID&com=on/fullstatus&project=1/2/3&notify=true/false\n"
    text += "Wireless Tags: /wlist /wtags\n"
    text += "WebSocket –≥–æ—Ç–æ–≤ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Delphi-–∫–ª–∏–µ–Ω—Ç–∞\n"
    try:
        await application.bot.send_message(
            OWNER_ID,
            text,
            disable_notification=True,
            reply_markup=get_reply_keyboard()
        )
        logger.info("–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: {e}")

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ü–æ–≥–æ–¥–∞ ‚Äî –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def weather_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return

    keyboard = []
    for key, city in CITIES_WEATHER.items():
        keyboard.append([
            InlineKeyboardButton(f"G {city['name']}", callback_data=f"weather_city_7_{key}"),
            InlineKeyboardButton(f"O {city['name']}", callback_data=f"weather_city_10_{key}")
        ])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        "üå§Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ —Å—Ä–æ–∫ –ø—Ä–æ–≥–Ω–æ–∑–∞:",
        reply_markup=reply_markup
    )


async def weather_city_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    if not query.data.startswith("weather_city_"):
        return

    city_key = query.data.split("_")[-1]
    if city_key not in CITIES_WEATHER:
        await query.edit_message_text("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω üòï")
        return

    city_name = CITIES_WEATHER[city_key]["name"]
    city_query = CITIES_WEATHER[city_key]["query"]

    await query.edit_message_text(f"–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è **{city_name}**... ‚è≥")

    try:
        forecast_text = await get_weather_7days(city=city_query)
        await query.edit_message_text(
            forecast_text,
            parse_mode="HTML",
            disable_web_page_preview=True
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–≥–æ–¥—ã –¥–ª—è {city_name}: {e}")
        await query.edit_message_text(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è {city_name}\n{e}")

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –Ω–∞ 7 –¥–Ω–µ–π —á–µ—Ä–µ–∑ Open-Meteo
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def get_weather_7days(
    city: str = "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
    lang: str = "ru",
    timeout: float = 10.0
) -> str:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –Ω–∞ 7 –¥–Ω–µ–π —á–µ—Ä–µ–∑ Open-Meteo
    –° —Ä—É—Å—Å–∫–∏–º–∏ –¥–Ω—è–º–∏ –Ω–µ–¥–µ–ª–∏ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –æ—Å–∞–¥–∫–æ–≤
    """
    async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=timeout)) as session:
        # 1. –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
        geo_url = f"https://geocoding-api.open-meteo.com/v1/search?name={city}&count=1&language=ru"
        try:
            async with session.get(geo_url) as resp:
                geo = await resp.json()
            if not geo.get("results"):
                return f"–ì–æ—Ä–æ–¥ ¬´{city}¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω üòî"
            location = geo["results"][0]
            lat = location["latitude"]
            lon = location["longitude"]
            name = location["name"]
            admin = location.get("admin1", "")
            country = location.get("country_code", "")
            place = f"{name}, {admin} {country}".strip(", ")
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞: {e.__class__.__name__}"

        # 2. –ü—Ä–æ–≥–Ω–æ–∑ (–¥–æ–±–∞–≤–ª—è–µ–º precipitation_probability_max)
        forecast_url = (
            f"https://api.open-meteo.com/v1/forecast?"
            f"latitude={lat}&longitude={lon}"
            "&daily=weather_code,temperature_2m_max,temperature_2m_min,"
            "precipitation_sum,precipitation_probability_max,wind_speed_10m_max"
            "&timezone=auto"
            "&forecast_days=7"
            f"&language={lang}"
        )

        try:
            async with session.get(forecast_url) as resp:
                data = await resp.json()
            if "error" in data:
                return f"–û—à–∏–±–∫–∞ API: {data.get('reason', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}"
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞: {e.__class__.__name__}"

        # 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        lines = [f"üå§Ô∏è <b>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π ‚Äî {place}</b>\n"]

        daily = data["daily"]
        ru_days = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"]

        for i in range(7):
            dt = datetime.fromisoformat(daily["time"][i])
            dow = ru_days[dt.weekday()]
            date_str = dt.strftime("%d.%m")

            t_max = daily["temperature_2m_max"][i]
            t_min = daily["temperature_2m_min"][i]
            precip_mm = daily["precipitation_sum"][i]
            precip_prob = daily["precipitation_probability_max"][i]
            wind = daily["wind_speed_10m_max"][i]
            code = daily["weather_code"][i]

            # –ò–∫–æ–Ω–∫–∞ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
            if code == 0:
                icon, desc = "‚òÄÔ∏è", "–Ø—Å–Ω–æ"
            elif code <= 3:
                icon, desc = "‚õÖ", "–ú–∞–ª–æ–æ–±–ª–∞—á–Ω–æ"
            elif code <= 48:
                icon, desc = "‚òÅÔ∏è", "–û–±–ª–∞—á–Ω–æ"
            elif code <= 67:
                icon, desc = "üåßÔ∏è", "–î–æ–∂–¥—å"
            elif code <= 77:
                icon, desc = "‚ùÑÔ∏è", "–°–Ω–µ–≥"
            elif code <= 86:
                icon, desc = "üåßÔ∏è‚ùÑÔ∏è", "–°–Ω–µ–≥ —Å –¥–æ–∂–¥—ë–º"
            else:
                icon, desc = "üå´Ô∏è", "–¢—É–º–∞–Ω/–≥—Ä–æ–∑–∞"

            temp_str = f"{t_min:+.0f} ‚Ä¶ {t_max:+.0f}¬∞"
            precip_str = f"üíß {precip_mm:>4.1f} –º–º ({precip_prob}% —à–∞–Ω—Å)"
            wind_str = f"üå¨Ô∏è {wind:>4.1f} –º/—Å"

            line = f"{dow}, {date_str}  {icon}  {temp_str}  {precip_str}  {wind_str}"
            lines.append(line)

        lines.append(f"\n–î–∞–Ω–Ω—ã–µ: Open-Meteo ‚Ä¢ {datetime.now().strftime('%H:%M')}")
        return "\n".join(lines)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –Ω–∞ 7 –¥–Ω–µ–π —á–µ—Ä–µ–∑ Gismeteo
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def get_gismeteo_forecast(city_key: str, days: int = 10) -> str:
        if i < len(temp_values):
            val = temp_values[i]
            maxt = val.find("div", class_="maxt")
            mint = val.find("div", class_="mint")

            t_max = maxt.find("temperature-value").get_text(strip=True) if maxt and maxt.find("temperature-value") else "?"
            t_min = mint.find("temperature-value").get_text(strip=True) if mint and mint.find("temperature-value") else "?"

            if t_max != "?" and t_min != "?":
                t_str = f"{t_min} ‚Ä¶ {t_max}¬∞"
                try:
                    t_num = float(t_max.replace("‚àí", "-").strip("¬∞"))  # –±–µ—Ä—ë–º –¥–Ω–µ–≤–Ω—É—é –¥–ª—è —ç–º–æ–¥–∑–∏
                    if t_num <= -10:
                        temp_emoji = "ü•∂‚ùÑÔ∏è"
                    elif t_num < 0:
                        temp_emoji = "‚ùÑÔ∏è"
                    elif t_num >= 25:
                        temp_emoji = "ü•µüî•"
                    elif t_num >= 15:
                        temp_emoji = "‚òÄÔ∏è"
                except:
                    pass

        # –ü–æ–≥–æ–¥–∞ + —ç–º–æ–¥–∑–∏
        condition = "?"
        weather_emoji = "üå´Ô∏è"
        if i < len(icon_items):
            tooltip = icon_items[i].get("data-tooltip", "").lower()
            if tooltip:
                condition = tooltip.capitalize()
                if "—è—Å–Ω–æ" in tooltip or "—Å–æ–ª–Ω–µ—á" in tooltip:
                    weather_emoji = "‚òÄÔ∏è"
                elif "–º–∞–ª–æ–æ–±–ª–∞—á" in tooltip:
                    weather_emoji = "‚õÖ"
                elif "–æ–±–ª–∞—á" in tooltip:
                    weather_emoji = "‚òÅÔ∏è"
                elif "–ø–∞—Å–º—É—Ä–Ω" in tooltip:
                    weather_emoji = "‚òÅÔ∏èüå´Ô∏è"
                elif "–¥–æ–∂–¥" in tooltip:
                    weather_emoji = "üåßÔ∏è"
                elif "—Å–Ω–µ–≥" in tooltip:
                    weather_emoji = "‚ùÑÔ∏è"
                elif "–≥—Ä–æ–∑" in tooltip:
                    weather_emoji = "‚õàÔ∏è"
                elif "—Ç—É–º–∞–Ω" in tooltip:
                    weather_emoji = "üå´Ô∏è"

        # –û—Å–∞–¥–∫–∏ + —ç–º–æ–¥–∑–∏
        precip = "0 –º–º"
        precip_emoji = ""
        if i < len(precip_units):
            unit = precip_units[i].get_text(strip=True)
            if unit and unit != "0":
                precip = f"{unit} –º–º"
                precip_emoji = "üíß" if "–¥–æ–∂–¥" in condition.lower() else "‚ùÑÔ∏è"

        line = (
            f"{weather_emoji} {day_text:>12}  "
            f"{temp_emoji} {t_str}  "
            f"{condition}  "
            f"{precip_emoji}{precip}"
        )
        lines.append(line)

    lines.append(f"\n<i>–î–∞–Ω–Ω—ã–µ: Gismeteo ‚Ä¢ {datetime.now().strftime('%H:%M %d.%m.%Y')}</i>")
    lines.append("<i>–ü—Ä–æ–≥–Ω–æ–∑ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏</i>")

    return "\n".join(lines)



#____________________________________________________________

            
            
async def weather_city_7_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    if not query.data.startswith("weather_city_7_"):
        return

    city_key = query.data.split("_")[-1]
    if city_key not in CITIES_WEATHER:
        await query.edit_message_text("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω üòï")
        return

    city_name = CITIES_WEATHER[city_key]["name"]

    await query.edit_message_text(f"–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π –¥–ª—è **{city_name}**... ‚è≥")

    try:
        forecast_text = await get_gismeteo_forecast(city_key, days=7 if "7_" in query.data else 10)
        await query.edit_message_text(
            forecast_text,
            parse_mode="HTML",
            disable_web_page_preview=True
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ 7-–¥–Ω–µ–≤–Ω–æ–π –ø–æ–≥–æ–¥—ã –¥–ª—è {city_name}: {e}")
        await query.edit_message_text(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å 7-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑\n{e}")


async def weather_city_10_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    if not query.data.startswith("weather_city_10_"):
        return

    city_key = query.data.split("_")[-1]
    if city_key not in CITIES_WEATHER:
        await query.edit_message_text("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω üòï")
        return

    city_name = CITIES_WEATHER[city_key]["name"]

    await query.edit_message_text(f"–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 10 –¥–Ω–µ–π –¥–ª—è **{city_name}**... ‚è≥")

    try:
        forecast_text = await get_weather_7days(city=CITIES_WEATHER[city_key]["query"])
        await query.edit_message_text(
            forecast_text,
            parse_mode="HTML",
            disable_web_page_preview=True
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ 10-–¥–Ω–µ–≤–Ω–æ–π –ø–æ–≥–æ–¥—ã –¥–ª—è {city_name}: {e}")
        await query.edit_message_text(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å 10-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑\n{e}")


    
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def add_user(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.effective_user.id != OWNER_ID:
        await update.message.reply_text("–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return
    if not context.args:
        await update.message.reply_text("–£–∫–∞–∂–∏ ID: /adduser 123456789")
        return
    try:
        new_id = int(context.args[0])
        if new_id in ALLOWED_USERS:
            await update.message.reply_text(f"ID {new_id} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω.")
            return
        ALLOWED_USERS.add(new_id)
        save_allowed_users(ALLOWED_USERS)
        await update.message.reply_text(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_id} –¥–æ–±–∞–≤–ª–µ–Ω. –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω.")
    except ValueError:
        await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID ‚Äî –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä.")
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞: {str(e)}")
async def remove_user(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.effective_user.id != OWNER_ID:
        await update.message.reply_text("–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return
    if not context.args:
        await update.message.reply_text("–£–∫–∞–∂–∏ ID: /removeuser 123456789")
        return
    try:
        rem_id = int(context.args[0])
        if rem_id == OWNER_ID:
            await update.message.reply_text("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞.")
            return
        if rem_id not in ALLOWED_USERS:
            await update.message.reply_text(f"ID {rem_id} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return
        ALLOWED_USERS.remove(rem_id)
        save_allowed_users(ALLOWED_USERS)
        await update.message.reply_text(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {rem_id} —É–¥–∞–ª—ë–Ω.")
    except ValueError:
        await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID.")
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞: {str(e)}")
async def list_users(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.effective_user.id != OWNER_ID:
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    if not ALLOWED_USERS:
        await update.message.reply_text("–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç (–∫—Ä–æ–º–µ —Ç–µ–±—è).")
        return
    text = "–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n" + "\n".join(str(uid) for uid in sorted(ALLOWED_USERS))
    await update.message.reply_text(text)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Wireless Tags –∫–æ–º–∞–Ω–¥—ã
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def wlist_tags(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    if not WTAGS_ENABLED:
        await update.message.reply_text("Wireless Tags –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞")
        return
    tags = wtags_get_tags()
    if not tags:
        await update.message.reply_text("–¢–µ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.\n–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥ –±–æ—Ç–∞.")
        return
    text = f"Wireless Sensor Tags ({len(tags)}):\n\n"
    keyboard = []
    for tag in tags:
        uuid = tag.get("uuid", "N/A")
        name = tag.get("name", "–ë–µ–∑ –∏–º–µ–Ω–∏")
        alive = tag.get("alive", False)
        temperature = tag.get("temperature")
        cap = tag.get("cap") # ‚Üê –±–µ—Ä—ë–º cap –≤–º–µ—Å—Ç–æ humidity
        battery_v = tag.get("batteryVolt") or tag.get("batteryLevel")
        # –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        temp_str = compact_value(temperature, "¬∞", decimals=1)
        cap_str = compact_value(cap, "%", decimals=0) if cap is not None and cap != 0 else None
        bat_str = compact_value(battery_v, "V", decimals=2 if battery_v is not None and battery_v < 10 else 1)
        # –≠–º–æ–¥–∑–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        if isinstance(temperature, (int, float)):
            if temperature < 0:
                temp_emoji = "‚ùÑÔ∏è"
            elif temperature > 30:
                temp_emoji = "üî•"
            elif temperature > 25:
                temp_emoji = "ü•µ"
            elif temperature < 10:
                temp_emoji = "ü•∂"
            else:
                temp_emoji = "üå°Ô∏è"
        else:
            temp_emoji = "üå°Ô∏è"
        # –≠–º–æ–¥–∑–∏ –±–∞—Ç–∞—Ä–µ–∏
        if isinstance(battery_v, (int, float)):
            bat_emoji = "ü™´" if battery_v < 2.7 else "üîã"
        else:
            bat_emoji = "üîã"
        # –°—Ç–∞—Ç—É—Å
        status_emoji = "üü¢" if alive else "‚ö´"
        status_text = "" if alive else "" #status_text = "–æ–Ω–ª–∞–π–Ω" if alive else "–æ—Ñ—Ñ–ª–∞–π–Ω"
        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–≤–µ —Å—Ç—Ä–æ–∫–∏
        text += f"{temp_emoji if alive else status_emoji} {name}\n"
        second_line = f" {temp_str} {bat_emoji}{bat_str}"
        if cap_str:
            second_line += f" üíß{cap_str}" # ‚Üê —ç–º–æ–¥–∑–∏ –∫–∞–ø–ª–∏ –ø–µ—Ä–µ–¥ cap
        second_line += f" {status_emoji} {status_text}"
        text += second_line + "\n\n"
        # –ö–Ω–æ–ø–∫–∞
        keyboard.append([
            InlineKeyboardButton(f"{status_emoji} {name}", callback_data=f"wtags_view_{uuid}")
        ])
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Telegram-–±–æ—Ç–∞
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞.")
        return
    current = context.bot_data.get("current_project", DEFAULT_PROJECT)
    text = (
        f"–ü—Ä–∏–≤–µ—Ç! Tuya Bot v{BOT_VERSION}\n"
        f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[current]['name']}\n"
        f"UID: {USER_UID}\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "‚Ä¢ /projects ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç (—Ç–µ–ø–µ—Ä—å 3 –¥–æ—Å—Ç—É–ø–Ω–æ)\n"
        "‚Ä¢ /list ‚Äî –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞\n"
        "‚Ä¢ /temp ‚Äî –¥–∞—Ç—á–∏–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã/–≤–ª–∞–∂–Ω–æ—Å—Ç–∏\n"
        "‚Ä¢ /switch ‚Äî –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏/—Ä–æ–∑–µ—Ç–∫–∏\n"
        "‚Ä¢ /status [id] ‚Äî –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å\n"
        "‚Ä¢ /wlist –∏–ª–∏ /wtags ‚Äî Wireless Sensor Tags\n"
        "‚Ä¢ /debug ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤–∫–ª—é—á–∞—è —Ñ–∞–π–ª—ã)\n"
        "‚Ä¢ /adduser, /removeuser, /users ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)"
    )
    await update.message.reply_text(text, reply_markup=get_reply_keyboard())
async def debug(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    current = context.bot_data.get("current_project", DEFAULT_PROJECT)
    text = f"Debug info v{BOT_VERSION}\n\n"
    text += f"–ü—Ä–æ–µ–∫—Ç: {TUYA_PROJECTS[current]['name']}\n"
    text += f"UID: {USER_UID}\n"
    text += f"–í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
    text += "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤:\n"
    text += "‚îÄ" * 40 + "\n"
    text += file_info(ALLOWED_USERS_FILE) + "\n\n"
    text += file_info(DEVICES_FILE) + "\n\n"
    text += file_info(BUTTON_STATS_FILE) + "\n\n"
    text += "‚îÄ" * 40 + "\n"
    text += "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ (UID –≤—Ä—É—á–Ω—É—é)"
    await update.message.reply_text(text, reply_markup=get_reply_keyboard())
async def projects(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    current = context.bot_data.get("current_project", DEFAULT_PROJECT)
    keyboard = []
    for key, proj in TUYA_PROJECTS.items():
        prefix = "‚úÖ " if key == current else ""
        keyboard.append([InlineKeyboardButton(f"{prefix}{proj['name']}", callback_data=f"switch_project_{key}")])
    await update.message.reply_text(
        f"–í—ã–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç (—Ç–µ–∫—É—â–∏–π: {TUYA_PROJECTS[current]['name']})",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def cmd_weather(update: Update, context: ContextTypes.DEFAULT_TYPE):
    city = " ".join(context.args) or "–ú–æ—Å–∫–≤–∞"
    text = await get_weather_7days(city)
    await update.message.reply_text(text, parse_mode="HTML", disable_web_page_preview=True)


async def switch_project_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    if not has_access(query.from_user.id):
        await query.edit_message_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    if query.data.startswith("switch_project_"):
        project_key = query.data.split("_", 2)[2]
        if project_key not in TUYA_PROJECTS:
            await query.edit_message_text("–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        try:
            await get_tuya_api(project_key, context)
            name = TUYA_PROJECTS[project_key]["name"]
            await query.edit_message_text(f"–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ {name} ‚úì\n–¢–µ–ø–µ—Ä—å /list /temp /switch")
        except Exception as e:
            await query.edit_message_text(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è: {str(e)}")
async def smart(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    devices = load_devices()
    if not devices:
        await update.message.reply_text("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –°–¥–µ–ª–∞–π /list —Å–Ω–∞—á–∞–ª–∞.")
        return
    text = f"–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ({len(devices)}):"
    keyboard = []
    row = []
    last_status = context.bot_data.get("last_status", {})
    for dev in devices:
        dev_id = dev.get("id")
        name = get_device_name(dev_id)
        emoji = "‚ö™"
        status_text = ""
        cached = last_status.get(dev_id, {})
        if cached.get("online", False):
            emoji = "üü¢"
        elif any(code in cached for code in SWITCH_CODES):
            state = any(cached.get(code, False) for code in SWITCH_CODES)
            emoji = "üü¢" if state else "üî¥"
        elif any(code in cached for code in TEMP_CODES):
            emoji = "üå°Ô∏è"
            temp = cached.get("va_temperature")
            if temp is not None:
                status_text = f" {temp/10:.0f}¬∞"
        button_text = f"{emoji}{name}{status_text}"
        row.append(InlineKeyboardButton(button_text, callback_data=f"device_{dev_id}"))
        if len(row) == 3:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
async def list_devices(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    try:
        tuya = await get_current_tuya(context)
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {str(e)}\n–ò—Å–ø–æ–ª—å–∑—É–π /projects")
        return
    uid = await get_uid(context)
    try:
        r = tuya.get(f"/v1.0/users/{uid}/devices")
        if not r.get("success"):
            await update.message.reply_text(format_tuya_error(r))
            return
        devices = r.get("result", [])
        if not devices:
            await update.message.reply_text("–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–∏–≤—è–∂–∏ –≤ iot.tuya.com")
            return
        update_devices_cache(devices)
        save_devices(devices)
        text = f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ({len(devices)}):"
        keyboard = []
        row = []
        last_status = context.bot_data.setdefault("last_status", {})
        for dev in devices:
            dev_id = dev.get("id")
            name = get_device_name(dev_id)
            emoji = "‚ö™"
            status_text = ""
            try:
                status_r = tuya.get(f"/v1.0/devices/{dev_id}/status")
                if status_r.get("success"):
                    current = {item["code"]: item["value"] for item in status_r["result"]}
                    last_status[dev_id] = current
                    online = current.get("online", False)
                    online_emoji = "üü¢" if online else "‚ö´"
                    if any(code in current for code in SWITCH_CODES):
                        state = any(current.get(code, False) for code in SWITCH_CODES)
                        emoji = "üü¢" if state else "üî¥"
                    elif any(code in current for code in TEMP_CODES):
                        emoji = "üå°Ô∏è"
                        temp = current.get("va_temperature") or current.get("temperature")
                        if temp is not None:
                            status_text = f" {temp/10:.0f}¬∞"
                else:
                    logger.warning(format_tuya_error(status_r))
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ {dev_id}: {e}")
                online_emoji = "‚ö´"
            button_text = f"{online_emoji} {emoji}{name}{status_text}"
            row.append(InlineKeyboardButton(button_text, callback_data=f"device_{dev_id}"))
            if len(row) == 3:
                keyboard.append(row)
                row = []
        if row:
            keyboard.append(row)
        await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ /list: {e}")
        await update.message.reply_text(f"–û—à–∏–±–∫–∞: {str(e)}")
async def show_temp(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    try:
        tuya = await get_current_tuya(context)
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {str(e)}")
        return
    uid = await get_uid(context)
    devices = []
    try:
        r = tuya.get(f"/v1.0/users/{uid}/devices")
        if r.get("success"):
            devices = r.get("result", [])
            update_devices_cache(devices)
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤: {str(e)}")
        return
    temp_devices = []
    for dev in devices:
        try:
            device_r = tuya.get(f"/v1.0/devices/{dev['id']}")
            online = False
            if device_r.get("success"):
                online = device_r["result"].get("online", False)
            status_r = tuya.get(f"/v1.0/devices/{dev['id']}/status")
            if status_r.get("success"):
                codes = {item["code"]: item["value"] for item in status_r["result"]}
                if any(code in codes for code in TEMP_CODES):
                    temp_devices.append((dev, codes, online))
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö {dev['id']}: {e}")
    if not temp_devices:
        await update.message.reply_text("–î–∞—Ç—á–∏–∫–æ–≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã/–≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return
    text = f"–î–∞—Ç—á–∏–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã/–≤–ª–∞–∂–Ω–æ—Å—Ç–∏ ({len(temp_devices)}):"
    keyboard = []
    for dev, codes, online in temp_devices:
        dev_id = dev.get("id")
        name = get_device_name(dev_id)
        temp = codes.get("va_temperature") or codes.get("temperature")
        hum = codes.get("va_humidity") or codes.get("humidity")
        battery_percent = codes.get("battery_percentage") or codes.get("battery") or codes.get("power") or codes.get("residual_capacity") or codes.get("battery_level")
        battery_state = codes.get("battery_state")
        temp_str = ""
        emoji = "üå°Ô∏è"
        if temp is not None:
            t_val = temp / 10
            if t_val < 0:
                emoji = "‚ùÑÔ∏è"
            elif t_val > 30:
                emoji = "üî•"
            temp_str += f" {t_val:.1f}¬∞"
        hum_str = ""
        if hum is not None:
            hum_str += f" üíß {hum}%"
        battery_str = ""
        battery_emoji = ""
        if battery_percent is not None:
            try:
                bat_val = int(float(battery_percent))
                if bat_val <= 20:
                    battery_emoji = "ü™´"
                elif bat_val <= 50:
                    battery_emoji = "üîã"
                else:
                    battery_emoji = "üîã"
                battery_str += f" {battery_emoji} {bat_val}%"
            except:
                battery_str += f" üîã {battery_percent}"
        elif battery_state is not None:
            state_lower = battery_state.lower()
            if state_lower == "low":
                battery_emoji = "ü™´"
                battery_str += " ü™´ Low"
            elif state_lower == "middle":
                battery_emoji = "üîã"
                battery_str += " üîã Middle"
            elif state_lower == "high":
                battery_emoji = "üîã"
                battery_str += " üîã High"
            else:
                battery_str += f" üîã {battery_state}"
        online_emoji = "üü¢ " if online else "‚ö´ "
        button_text = f"{online_emoji} {emoji} {name}{temp_str}{hum_str}{battery_str}"
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"device_{dev_id}")])
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
async def show_switch(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    try:
        tuya = await get_current_tuya(context)
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {str(e)}")
        return
    uid = await get_uid(context)
    devices = []
    try:
        r = tuya.get(f"/v1.0/users/{uid}/devices")
        if r.get("success"):
            devices = r.get("result", [])
            update_devices_cache(devices)
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤: {str(e)}")
        return
    switch_devices = []
    for dev in devices:
        try:
            status_r = tuya.get(f"/v1.0/devices/{dev['id']}/status")
            if status_r.get("success"):
                codes = {item["code"]: item["value"] for item in status_r["result"]}
                has_switch = any(code in codes for code in SWITCH_CODES)
                has_temp = any(code in codes for code in TEMP_CODES)
                if has_switch and not has_temp:
                    switch_devices.append((dev, codes))
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ {dev['id']}: {e}")
    if not switch_devices:
        await update.message.reply_text("–í—ã–∫–ª—é—á–∞—Ç–µ–ª–µ–π/—Ä–æ–∑–µ—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return
    text = f"–í—ã–∫–ª—é—á–∞—Ç–µ–ª–∏/—Ä–æ–∑–µ—Ç–∫–∏ ({len(switch_devices)}):"
    keyboard = []
    row = []
    for idx, (dev, codes) in enumerate(switch_devices):
        dev_id = dev.get("id")
        name = get_device_name(dev_id)
        state = any(codes.get(code, False) for code in SWITCH_CODES)
        emoji = "üü¢" if state else "üî¥"
        button_text = f"{emoji} {name}"
        row.append(InlineKeyboardButton(button_text, callback_data=f"device_{dev_id}"))
        if len(row) == 2 or idx == len(switch_devices) - 1:
            keyboard.append(row)
            row = []
    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None
    if not keyboard:
        text += "\n\n(–ö–Ω–æ–ø–∫–∏ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤)"
    await update.message.reply_text(text, reply_markup=reply_markup)
async def status(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    if not context.args:
        await update.message.reply_text("–£–∫–∞–∂–∏ ID: /status bf93e7545f941db90dk4h6")
        return
    dev_id = context.args[0].strip()
    try:
        tuya = await get_current_tuya(context)
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞: {str(e)}")
        return
    try:
        r = tuya.get(f"/v1.0/devices/{dev_id}/status")
        if r.get("success"):
            text = f"–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å {dev_id}:\n\n"
            name = get_device_name(dev_id)
            text += f"–ò–º—è: {name}\n"
            text += f"ID: {dev_id}\n\n"
            for item in r["result"]:
                code = item["code"]
                value = item["value"]
                if code in TEMP_CODES:
                    if "temperature" in code:
                        text += f"{code}: {value / 10:.1f}¬∞C\n"
                    elif "humidity" in code:
                        text += f"{code}: {value}%\n"
                elif code in SWITCH_CODES:
                    text += f"{code}: {'–í–∫–ª' if value else '–í—ã–∫–ª'}\n"
                elif code == "online":
                    text += f"–°—Ç–∞—Ç—É—Å: {'Online' if value else 'Offline'}\n"
                elif code == "battery_percentage":
                    text += f"–ë–∞—Ç–∞—Ä–µ—è: {value}%\n"
                else:
                    text += f"{code}: {value}\n"
            await update.message.reply_text(text)
        else:
            await update.message.reply_text(format_tuya_error(r))
    except Exception as e:
        logger.exception(f"–û—à–∏–±–∫–∞ /status {dev_id}: {e}")
        name = get_device_name(dev_id)
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.\n–ò–º—è –∏–∑ –∫—ç—à–∞: {name}\nID: {dev_id}")
        
# ==================== BUTTON CALLBACK ====================
async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    if not has_access(query.from_user.id):
        await query.edit_message_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    data = query.data
    try:
        tuya = await get_current_tuya(context)
    except Exception as e:
        await query.edit_message_text(f"–û—à–∏–±–∫–∞: {str(e)}")
        return

    # ==================== USB –¢–û–ì–ì–õ ====================
    if data.startswith("usb1_toggle_") or data.startswith("usb2_toggle_"):
        try:
            parts = data.split("_")
            usb_num = 1 if parts[0] == "usb1" else 2
            port_str = parts[-1]
            port_num = int(port_str)
            names = USB1_NAMES if usb_num == 1 else USB2_NAMES
            state_key = f"usb{usb_num}_states"
            if state_key not in context.bot_data:
                context.bot_data[state_key] = [False] * 8
            states = context.bot_data[state_key]
            old_state = states[port_num - 1]
            new_state = not old_state
            states[port_num - 1] = new_state

            port_formatted = f"{port_num:02d}"
            command_str = f"usb{usb_num}, {port_formatted}, {str(new_state).lower()}"

            client_id = "delphi"  # ‚Üê –ø–æ–º–µ–Ω—è–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            success = send_to_delphi(client_id, {
                "command": "usb_control",
                "data": command_str
            })
            status = "—É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞" if success else "–∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω"

            await query.edit_message_text(
                f"USB{usb_num} {names[port_num-1]} ‚Üí {'üü¢ –í–ö–õ' if new_state else 'üî¥ –í–´–ö–õ'}\n"
                f"–ö–æ–º–∞–Ω–¥–∞: {command_str}\n"
                f"–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì\n"
                f"–í Delphi: {status}"
            )
            await show_usb_menu_from_query(query, context, usb_num)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ USB callback: {str(e)}")
            await query.edit_message_text(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ USB: {str(e)}")
        return
    # ==================================================
         
    if data.startswith("device_"):
        dev_id = data[7:]
        try:
            name = get_device_name(dev_id)
            r = tuya.get(f"/v1.0/devices/{dev_id}/status")
            if not r.get("success"):
                await query.edit_message_text(format_tuya_error(r))
                return
            text = f"{name} ({dev_id})\n\n"
            switch_value = None
            for item in r["result"]:
                code = item["code"]
                value = item["value"]
                if code in SWITCH_CODES:
                    switch_value = value
                    text += f"–í–∫–ª—é—á–µ–Ω–æ: {'–î–∞' if value else '–ù–µ—Ç'}\n"
                elif code in TEMP_CODES:
                    if "temperature" in code:
                        text += f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {value / 10:.1f}¬∞C\n"
                    elif "humidity" in code:
                        text += f"–í–ª–∞–∂–Ω–æ—Å—Ç—å: {value}%\n"
                elif code == "battery_percentage":
                    text += f"–ë–∞—Ç–∞—Ä–µ—è: {value}%\n"
                elif code == "online":
                    text += f"–°—Ç–∞—Ç—É—Å: {'Online' if value else 'Offline'}\n"
            keyboard = []
            if switch_value is not None:
                keyboard.append([
                    InlineKeyboardButton("–í–ö–õ", callback_data=f"on_{dev_id}"),
                    InlineKeyboardButton("–í–´–ö–õ", callback_data=f"off_{dev_id}"),
                    InlineKeyboardButton("‚Üª –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å", callback_data=f"toggle_{dev_id}")
                ])
            keyboard.append([InlineKeyboardButton("–ü–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å", callback_data=f"fullstatus_{dev_id}")])
            await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
        except Exception as e:
            await query.edit_message_text(f"–û—à–∏–±–∫–∞: {str(e)}")
    elif data.startswith("on_") or data.startswith("off_") or data.startswith("toggle_"):
        dev_id = data.split("_", 1)[1]
        try:
            r = tuya.get(f"/v1.0/devices/{dev_id}/status")
            if not r.get("success"):
                await query.edit_message_text(format_tuya_error(r))
                return
            current = None
            for item in r["result"]:
                if item["code"] in SWITCH_CODES:
                    current = item["value"]
                    break
            if current is None:
                await query.edit_message_text("–ù–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è")
                return
            if data.startswith("toggle_"):
                value = not current
                action = "–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ"
            else:
                value = data.startswith("on_")
                action = "–≤–∫–ª—é—á–µ–Ω–æ" if value else "–≤—ã–∫–ª—é—á–µ–Ω–æ"
            payload = {"commands": [{"code": "switch_1", "value": value}]}
            cmd_r = tuya.post(f"/v1.0/devices/{dev_id}/commands", payload)
            if cmd_r.get("success"):
                await query.edit_message_text(f"{action.capitalize()} ‚úì")
            else:
                await query.edit_message_text(format_tuya_error(cmd_r))
        except Exception as e:
            await query.edit_message_text(f"–û—à–∏–±–∫–∞: {str(e)}")
    elif data.startswith("fullstatus_"):
        dev_id = data[11:]
        try:
            r = tuya.get(f"/v1.0/devices/{dev_id}/status")
            if not r.get("success"):
                await query.edit_message_text(format_tuya_error(r))
                return
            name = get_device_name(dev_id)
            text = f"–ü–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å {name} ({dev_id}):\n\n"
            for item in r["result"]:
                code = item["code"]
                value = item["value"]
                if code in TEMP_CODES:
                    if "temperature" in code:
                        text += f"{code}: {value / 10:.1f}¬∞C\n"
                    elif "humidity" in code:
                        text += f"{code}: {value}%\n"
                elif code in SWITCH_CODES:
                    text += f"{code}: {'–í–∫–ª' if value else '–í—ã–∫–ª'}\n"
                elif code == "online":
                    text += f"–°—Ç–∞—Ç—É—Å: {'Online' if value else 'Offline'}\n"
                elif code == "battery_percentage":
                    text += f"–ë–∞—Ç–∞—Ä–µ—è: {value}%\n"
                else:
                    text += f"{code}: {value}\n"
            await query.edit_message_text(text)
        except Exception as e:
            await query.edit_message_text(f"–û—à–∏–±–∫–∞: {str(e)}")
    elif data.startswith("wtags_view_"):
        uuid = data[11:]
        if not WTAGS_ENABLED:
            await query.edit_message_text("Wireless Tags –æ—Ç–∫–ª—é—á–µ–Ω—ã")
            return
        readings = wtags_get_readings(uuid)
        text = f"–î–∞–Ω–Ω—ã–µ —Ç–µ–≥–∞ {uuid}:\n\n"
        if readings:
            temp = readings.get("temperature", "N/A")
            cap = readings.get("cap", "N/A")
            text += f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp} ¬∞C\n"
            text += f"Cap: {cap} %\n"
            text += "\n(–¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ª–æ–≥–∞—Ö –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—å —Ñ—É–Ω–∫—Ü–∏—é)"
        else:
            text += "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è (–ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥ –±–æ—Ç–∞)"
        await query.edit_message_text(text)

async def show_usb_menu_from_query(query, context: ContextTypes.DEFAULT_TYPE, usb_num: int):
    """–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ USB-–º–µ–Ω—é –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å CallbackQuery)"""
    names = USB1_NAMES if usb_num == 1 else USB2_NAMES
    state_key = f"usb{usb_num}_states"
    if state_key not in context.bot_data:
        context.bot_data[state_key] = [False] * 8
    states = context.bot_data[state_key]

    keyboard = []
    row = []
    for i in range(8):
        state = states[i]
        emoji = "üü¢" if state else "üî¥"
        button_text = f"{emoji} {names[i]}"
        callback_data = f"usb{usb_num}_toggle_{i+1:02d}"
        row.append(InlineKeyboardButton(button_text, callback_data=callback_data))
        if len(row) == 2:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)

    await query.edit_message_reply_markup(reply_markup=InlineKeyboardMarkup(keyboard))


async def handle_keyboard_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return
    text = update.message.text.strip()
    if text in ["üîå –í—ã–∫–ª—é—á–∞—Ç–µ–ª–∏", "–í—ã–∫–ª—é—á–∞—Ç–µ–ª–∏"]:
        await show_switch(update, context)
    elif text in ["üå°Ô∏è –î–∞—Ç—á–∏–∫–∏", "–î–∞—Ç—á–∏–∫–∏"]:
        await show_temp(update, context)
    elif text in ["üìã –ü—Ä–æ–µ–∫—Ç—ã", "–ü—Ä–æ–µ–∫—Ç—ã"]:
        await projects(update, context)
    elif text in ["üìú –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤", "–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤"]:
        await list_devices(update, context)
    elif text in ["üè∑Ô∏è Wireless Tags", "Wireless Tags"]:
        await wlist_tags(update, context)
    elif text in ["USB1", "–†–µ–ª–µ 1"]:
        await show_usb_menu(update, context, usb_num=1)
    elif text in ["USB2", "–†–µ–ª–µ 2"]:
        await show_usb_menu(update, context, usb_num=2)
    elif text in ["üå§Ô∏è –ü–æ–≥–æ–¥–∞", "–ü–æ–≥–æ–¥–∞"]:
        await weather_menu(update, context)
        
    elif text == "/start":
        await start(update, context)
    else:
        await update.message.reply_text("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã üòâ")
#_______________________________________________________________________________            
#–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –ø–æ–∫–∞–∑ –ø–æ–¥–º–µ–Ω—é USB (8 –∫–Ω–æ–ø–æ–∫)
#_______________________________________________________________________________    

async def show_usb_menu(update: Update, context: ContextTypes.DEFAULT_TYPE, usb_num: int):
    names = USB1_NAMES if usb_num == 1 else USB2_NAMES
    state_key = f"usb{usb_num}_states"
    if state_key not in context.bot_data:
        context.bot_data[state_key] = [False] * 8
    states = context.bot_data[state_key]
    keyboard = []
    row = []
    for i in range(8):
        state = states[i]
        emoji = "üü¢" if state else "üî¥"
        button_text = f"{emoji} {names[i]}"
        # callback_data —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–º–µ—Ä –ø–æ—Ä—Ç–∞ —è–≤–Ω–æ
        callback_data = f"usb{usb_num}_toggle_{i+1:02d}" # 01, 02, ..., 08
        row.append(InlineKeyboardButton(button_text, callback_data=callback_data))
        if len(row) == 2: # 2 –∫–æ–ª–æ–Ω–∫–∏
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ USB{usb_num} ({len(names)} —É—Å—Ç—Ä–æ–π—Å—Ç–≤)",
        reply_markup=reply_markup
    )
#_______________________________________________________________________________    

async def main():
    logger.info(f"–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤–µ—Ä—Å–∏–∏ {BOT_VERSION} (Telegram polling + HTTP control + Wireless Tags + WebSocket)")
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    logger.info("Flask + SocketIO —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ")
    app = Application.builder().token(TELEGRAM_TOKEN).post_init(post_init).build()
    global application_global
    application_global = app
    app.add_handler(CommandHandler("adduser", add_user))
    app.add_handler(CommandHandler("removeuser", remove_user))
    app.add_handler(CommandHandler("users", list_users))
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("projects", projects))
    app.add_handler(CommandHandler("debug", debug))
    app.add_handler(CommandHandler("list", list_devices))
    app.add_handler(CommandHandler("smart", smart))
    app.add_handler(CommandHandler("temp", show_temp))
    app.add_handler(CommandHandler("switch", show_switch))
    app.add_handler(CommandHandler("status", status))
    app.add_handler(CommandHandler("wlist", wlist_tags))
    app.add_handler(CommandHandler("wtags", wlist_tags))
    app.add_handler(CallbackQueryHandler(switch_project_callback, pattern="^switch_project_"))
    app.add_handler(CallbackQueryHandler(weather_city_7_callback, pattern="^weather_city_7_"))
    app.add_handler(CallbackQueryHandler(weather_city_10_callback, pattern="^weather_city_10_"))
    app.add_handler(CallbackQueryHandler(button_callback))  # –±–µ–∑ pattern
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_keyboard_buttons))
    app.add_handler(CommandHandler("weather", cmd_weather))
    app.add_handler(CommandHandler("weather_menu", weather_menu))
    
    try:
        await app.bot.delete_webhook(drop_pending_updates=True)
        logger.info("Webhook —Å–±—Ä–æ—à–µ–Ω")
    except Exception:
        pass
    await app.initialize()
    await app.start()
    await app.updater.start_polling(
        poll_interval=1.0,
        timeout=10,
        drop_pending_updates=True
    )
    logger.info("Polling –∑–∞–ø—É—â–µ–Ω")
    try:
        await asyncio.Event().wait()
    finally:
        logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞")
        await app.updater.stop()
        await app.stop()
        await app.shutdown()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ß–∏—Å—Ç—ã–π WebSocket (flask-sock) –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ Delphi
# –†–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å Socket.IO, –±–µ–∑ —Å–ª–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
sock = Sock(flask_app)

@sock.route('/ws')
def pure_websocket(ws):
    token = request.args.get('token')
    client_id = request.args.get('client_id', 'unknown')
    
    if token != WEBSOCKET_SECRET_TOKEN:
        logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –æ—Ç {client_id} (IP: {request.remote_addr})")
        ws.close()
        return
    
    logger.info(f"–ß–∏—Å—Ç—ã–π WS –ø–æ–¥–∫–ª—é—á—ë–Ω: {client_id} (IP: {request.remote_addr})")
    
    while True:
        try:
            data = ws.receive()
            if data is None:
                break
            try:
                msg = json.loads(data)
                cmd = msg.get('command')
                
                if cmd == 'ping':
                    ws.send(json.dumps({
                        'response': 'pong',
                        'client_id': client_id,
                        'timestamp': time.time()
                    }))
                elif cmd == 'usb_control':
                    usb_data = msg.get('data')
                    logger.info(f"USB –∫–æ–º–∞–Ω–¥–∞ –æ—Ç {client_id}: {usb_data}")
                    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É –≤ Telegram
                    asyncio.run_coroutine_threadsafe(
                        application_global.bot.send_message(
                            OWNER_ID,
                            f"USB –∫–æ–º–∞–Ω–¥–∞ —á–µ—Ä–µ–∑ —á–∏—Å—Ç—ã–π WS –æ—Ç {client_id}:\n{usb_data}"
                        ),
                        notify_loop
                    )
                    ws.send(json.dumps({'response': 'ok', 'data': usb_data}))
                elif cmd == 'get_wtags':
                    tags = wtags_get_tags()
                    ws.send(json.dumps({
                        'response': 'wtags',
                        'count': len(tags),
                        'data': tags
                    }))
                else:
                    ws.send(json.dumps({'response': 'unknown_command'}))
            except json.JSONDecodeError:
                ws.send(json.dumps({'response': 'invalid_json'}))
        except Exception as e:
            logger.error(f"WS –æ—à–∏–±–∫–∞ –æ—Ç {client_id}: {e}")
            break
    
    logger.info(f"–ß–∏—Å—Ç—ã–π WS –æ—Ç–∫–ª—é—á—ë–Ω: {client_id}")


if __name__ == "__main__":
    asyncio.run(main())
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–∞:
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ (–±–µ–∑ –ø—É—Å—Ç—ã—Ö –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤): 2061
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π/–ø—Ä–æ—Ü–µ–¥—É—Ä (async def + def): 40
# –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: 2026-02-12
# –ò–∑–º–µ–Ω–µ–Ω–∏—è: —Ñ–∏–∫—Å async_mode –Ω–∞ threading, –ø—Ä–æ–ø–∏—Å–∞–Ω –¥–æ–º–µ–Ω, –≤–µ—Ä—Å–∏—è 6.13
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
