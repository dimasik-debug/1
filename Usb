–í–æ—Ç –ø–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–≤–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
–ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –±–æ—Ç–∞
–î–≤–µ –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é: USB1 –∏ USB2
–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ USB1 –∏–ª–∏ USB2 –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥–º–µ–Ω—é —Å 8 –∫–Ω–æ–ø–∫–∞–º–∏ (2 —Ä—è–¥–∞ –ø–æ 4 —à—Ç.)
–ö–∞–∂–¥–∞—è –∏–∑ 8 –∫–Ω–æ–ø–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤ Delphi —á–µ—Ä–µ–∑ WebSocket:
usb1, 01, true   –∏–ª–∏   usb1, 01, false   (–¥–ª—è USB1)
usb2, 01, true   –∏–ª–∏   usb2, 01, false   (–¥–ª—è USB2)
–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–π –∏–∑ 8 –∫–Ω–æ–ø–æ–∫ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è (–≤ bot_data)
–ö–Ω–æ–ø–∫–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è:
üü¢ –∑–µ–ª—ë–Ω—ã–π ‚Äî true (–≤–∫–ª—é—á–µ–Ω–æ)
üî¥ –∫—Ä–∞—Å–Ω—ã–π ‚Äî false (–≤—ã–∫–ª—é—á–µ–Ω–æ)
1. –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (get_reply_keyboard)
def get_reply_keyboard():
    keyboard = [
        [KeyboardButton("üîå –í—ã–∫–ª—é—á–∞—Ç–µ–ª–∏"), KeyboardButton("üå°Ô∏è –î–∞—Ç—á–∏–∫–∏")],
        [KeyboardButton("üìã –ü—Ä–æ–µ–∫—Ç—ã"), KeyboardButton("üìú –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤")],
        [KeyboardButton("üè∑Ô∏è Wireless Tags")],
        [KeyboardButton("USB1"), KeyboardButton("USB2")]   # ‚Üê –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
2. –û–±–Ω–æ–≤–ª—è–µ–º handle_keyboard_buttons (–¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫)
async def handle_keyboard_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not has_access(update.effective_user.id):
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω")
        return

    text = update.message.text.strip()

    if text in ["üîå –í—ã–∫–ª—é—á–∞—Ç–µ–ª–∏", "–í—ã–∫–ª—é—á–∞—Ç–µ–ª–∏"]:
        await show_switch(update, context)
    elif text in ["üå°Ô∏è –î–∞—Ç—á–∏–∫–∏", "–î–∞—Ç—á–∏–∫–∏"]:
        await show_temp(update, context)
    elif text in ["üìã –ü—Ä–æ–µ–∫—Ç—ã", "–ü—Ä–æ–µ–∫—Ç—ã"]:
        await projects(update, context)
    elif text in ["üìú –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤", "–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤"]:
        await list_devices(update, context)
    elif text in ["üè∑Ô∏è Wireless Tags", "Wireless Tags"]:
        await wlist_tags(update, context)

    # ‚îÄ‚îÄ –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ USB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    elif text == "USB1":
        await show_usb_menu(update, context, usb_num=1)
    elif text == "USB2":
        await show_usb_menu(update, context, usb_num=2)

    elif text == "/start":
        await start(update, context)
    else:
        await update.message.reply_text("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞")
3. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –ø–æ–∫–∞–∑ –ø–æ–¥–º–µ–Ω—é USB (8 –∫–Ω–æ–ø–æ–∫)
async def show_usb_menu(update: Update, context: ContextTypes.DEFAULT_TYPE, usb_num: int):
    # –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ bot_data
    state_key = f"usb{usb_num}_states"  # usb1_states –∏–ª–∏ usb2_states
    if state_key not in context.bot_data:
        context.bot_data[state_key] = [False] * 8  # 8 –∫–Ω–æ–ø–æ–∫, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω—ã

    states = context.bot_data[state_key]

    keyboard = []
    row = []
    for i in range(8):
        state = states[i]
        emoji = "üü¢" if state else "üî¥"
        text = f"{emoji} {i+1}"
        callback_data = f"usb{usb_num}_toggle_{i+1}"
        row.append(InlineKeyboardButton(text, callback_data=callback_data))

        if len(row) == 4:
            keyboard.append(row)
            row = []

    if row:
        keyboard.append(row)

    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ USB{usb_num} (8 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)",
        reply_markup=reply_markup
    )
4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ inline-–∫–Ω–æ–ø–∫–∏ USB (–¥–æ–±–∞–≤—å –≤ button_callback)
–ù–∞–π–¥–∏ —Ñ—É–Ω–∫—Ü–∏—é async def button_callback(...) –∏ –¥–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ –∏–ª–∏ –≤ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ:
# ‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ USB-–∫–Ω–æ–ø–æ–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if data.startswith("usb1_toggle_") or data.startswith("usb2_toggle_"):
        usb_num = 1 if data.startswith("usb1_") else 2
        port_num = int(data.split("_")[-1])  # 1..8

        state_key = f"usb{usb_num}_states"
        if state_key not in context.bot_data:
            context.bot_data[state_key] = [False] * 8

        states = context.bot_data[state_key]
        old_state = states[port_num - 1]
        new_state = not old_state
        states[port_num - 1] = new_state

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        context.bot_data[state_key] = states

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è Delphi
        command_str = f"usb{usb_num}, 01, {str(new_state).lower()}"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ WebSocket (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç)
        client_id = "delphi"  # ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π client_id —Ç–≤–æ–µ–≥–æ Delphi
        success = send_to_delphi(client_id, {
            "command": "usb_control",
            "data": command_str
        })

        status = "—É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞" if success else "–∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω"

        await query.edit_message_text(
            f"USB{usb_num} –ø–æ—Ä—Ç {port_num} ‚Üí {new_state}\n"
            f"–ö–æ–º–∞–Ω–¥–∞: {command_str}\n"
            f"–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì\n"
            f"–í Delphi: {status}"
        )

        return
5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –º–µ–Ω—é —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å (–∫–Ω–æ–ø–∫–∏ –º–µ–Ω—è–ª–∏ —Ü–≤–µ—Ç), –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É:
# –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω—é
        await show_usb_menu(update, context, usb_num)
        await query.delete_message()  # —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
–ù–æ —ç—Ç–æ —É–∂–µ –ø–æ –≤–∫—É—Å—É.
–ò—Ç–æ–≥: —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–æ—Å—å
–î–≤–µ –∫–Ω–æ–ø–∫–∏ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é: USB1, USB2
–ü–æ–¥–º–µ–Ω—é —Å 8 inline-–∫–Ω–æ–ø–∫–∞–º–∏ (üü¢ / üî¥)
–ó–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ context.bot_data
–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –≤–∏–¥–∞ usb1, 01, true / usb2, 01, false —á–µ—Ä–µ–∑ send_to_delphi
–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –≤ button_callback
–ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–¥–∞ ‚Üí commit ‚Üí push ‚Üí –¥–µ–ø–ª–æ–π ‚Üí –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã, client_id –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π ‚Äî —Å–∫–∞–∂–∏, –ø–æ–¥–ø—Ä–∞–≤–∏–º.
